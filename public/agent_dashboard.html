<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="apple-touch-icon.png">
    <title>Agent Dashboard - Shop Manager</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --primary: #009879; --secondary: #007a63; }
        .text-primary { color: var(--primary); }
        .bg-primary { background-color: var(--primary); }
        .hover\:bg-secondary:hover { background-color: var(--secondary); }

        .dark { background-color: #121212; color: #e0e0e0; }
        .dark .bg-white { background-color: #1f1f1f; color: #e0e0e0; }
        .dark .shadow-xl { box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.4), 0 10px 10px -5px rgba(0, 0, 0, 0.2); }
        .dark input, .dark select { background-color: #374151; border-color: #4b5563; color: #f3f4f6; }
        .dark .border-gray-100 { border-color: #374151; }

        /* Sidebar Styles */
        #sidebar {
            width: 250px;
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            z-index: 60;
            box-shadow: 10px 0 20px rgba(0, 0, 0, 0.4);
        }
        #sidebar.open {
            transform: translateX(0);
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans dark:bg-[#121212]">
    
    <!-- Toast Notification Container -->
    <div id="toast-container" class="fixed top-4 right-4 z-50 max-w-sm"></div>

    <!-- Navigation Drawer (Sidebar) -->
    <div id="sidebar-backdrop" class="fixed inset-0 bg-black bg-opacity-50 z-50 hidden" onclick="toggleSidebar()"></div>
    <div id="sidebar" class="fixed top-0 left-0 h-full bg-white dark:bg-[#1f1f1f] p-5">
        <h3 class="text-2xl font-bold text-gray-800 dark:text-white mb-6">Agent Menu</h3>
        
        <!-- Wallet Balance in Sidebar -->
        <div class="mb-6 pb-4 border-b border-gray-200 dark:border-gray-700">
            <p class="text-sm text-gray-600 dark:text-gray-400 font-medium">Main Wallet:</p>
            <p id="sidebar-wallet-balance" class="text-2xl font-extrabold text-gray-800 dark:text-white">GHS 0.00</p>
            <p class="text-sm text-gray-600 dark:text-gray-400 font-medium mt-2">Payout Profit:</p>
            <p id="sidebar-payout-balance" class="text-2xl font-extrabold text-green-500">GHS 0.00</p>
        </div>

        <div class="space-y-4">
            <a href="/purchase.html" class="block text-gray-700 dark:text-gray-300 hover:text-primary font-medium">Buy Data (Self)</a>
            <a href="/dashboard.html" class="block text-gray-700 dark:text-gray-300 hover:text-primary font-medium">Client Dashboard</a>
            
            <a href="#" class="block text-primary font-bold">Shop Manager</a>
            <a href="/support.html" class="block text-gray-700 dark:text-gray-300 hover:text-primary font-medium">Support & FAQ</a>
            
            <a href="/api/logout" class="block text-red-500 hover:text-red-700 font-medium pt-4 border-t border-gray-200 dark:border-gray-700">Logout</a>
        </div>
        <button id="close-sidebar" class="absolute top-4 right-4 text-gray-500 dark:text-gray-400 hover:text-gray-800 dark:hover:text-white" onclick="toggleSidebar()">
            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
        </button>
    </div>

    <!-- Navbar -->
    <nav class="bg-white shadow-lg dark:bg-[#1f1f1f]">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
            <div class="flex items-center">
                <button id="open-sidebar" class="p-2 rounded-full text-gray-600 hover:bg-gray-100 dark:text-gray-300 dark:hover:bg-gray-700 transition mr-4" onclick="toggleSidebar()">
                    <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4 6h16M4 12h16M4 18h16" />
                    </svg>
                </button>
                <a href="/dashboard.html" class="text-xl font-bold text-primary">Agent Manager</a>
            </div>
            
            <a href="/api/logout" class="text-red-500 hover:text-red-700 transition font-medium">Logout</a>
        </div>
    </nav>

    <!-- Main Content Container -->
    <div class="container mx-auto p-4 max-w-5xl">
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl mt-8 border border-gray-100 dark:bg-[#1f1f1f] dark:border-gray-700">
            
            <h1 class="text-3xl font-extrabold text-gray-800 dark:text-white mb-2">
                Your Agent Storefront
            </h1>
            
            <!-- Shop Link Display -->
            <div class="mb-8 p-4 bg-blue-50 border border-blue-200 rounded-lg dark:bg-blue-900 dark:border-blue-700">
                <p class="font-medium text-gray-700 dark:text-blue-200">Your Shop Link (Share this with your clients):</p>
                <div class="flex items-center mt-1">
                    <input type="text" id="shop-link" readonly class="flex-grow p-2 text-sm bg-white dark:bg-gray-700 dark:text-white border border-gray-300 rounded-l-md" value="Loading...">
                    <button id="copy-link-btn" class="bg-primary text-white p-2 rounded-r-md text-sm font-semibold hover:bg-secondary">
                        Copy
                    </button>
                </div>
            </div>

            <!-- Profit and Payout Card -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-10">
                <div class="p-5 border border-gray-200 rounded-xl shadow-md dark:border-gray-700 dark:bg-[#282828]">
                    <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Current Profit Balance</p>
                    <p id="profit-balance" class="text-3xl font-extrabold text-green-600 mt-1">GHS 0.00</p>
                </div>
                <div class="p-5 border border-gray-200 rounded-xl shadow-md dark:border-gray-700 dark:bg-[#282828] col-span-2 flex flex-col justify-center">
                    <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-3">Withdrawal Request</h3>
                    <div class="flex space-x-3">
                        <input type="number" id="payout-amount" min="10.00" step="1.00" placeholder="Amount (GHS)" class="flex-grow p-2 border rounded-lg dark:bg-gray-700 dark:border-gray-600">
                        <button id="request-payout-btn" class="bg-red-500 text-white font-bold py-2 px-4 rounded-lg hover:bg-red-600 transition">
                            Request Payout
                        </button>
                    </div>
                </div>
            </div>

            <!-- Pricing Manager Section -->
            <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4 border-b pb-2">
                Custom Pricing Manager (Markup in Pesewas)
            </h2>
            <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">
                Set a fixed markup (in pesewas) for each network. Your client will pay **Wholesale Cost + Your Markup**. Must be $\ge 0$.
            </p>

            <div id="pricing-manager-status" class="text-center font-medium mb-4 text-gray-700 dark:text-gray-400">Loading pricing data...</div>

            <div id="pricing-forms" class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Forms will be generated here -->
            </div>
            
        </div>
    </div>

    <!-- JavaScript Logic -->
    <script>
        // --- TOAST NOTIFICATION SYSTEM ---
        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const colors = {
                success: 'bg-green-500 border-green-700',
                error: 'bg-red-500 border-red-700',
                warning: 'bg-yellow-500 border-yellow-700',
            };
            const toast = document.createElement('div');
            toast.className = `p-4 mb-2 text-white text-sm font-semibold rounded-lg shadow-lg border-b-4 ${colors[type]} transform translate-x-full transition-all duration-300 ease-out`;
            toast.textContent = message;

            container.prepend(toast);

            setTimeout(() => {
                toast.style.transform = 'translateX(0)';
            }, 10);

            setTimeout(() => {
                toast.style.transform = 'translateX(120%)';
                setTimeout(() => {
                    container.removeChild(toast);
                }, 400);
            }, 6000);
        }
        // --- END TOAST SYSTEM ---

        // --- GLOBAL STATE ---
        let currentShopId = '';
        let currentMarkups = { MTN: 0, AirtelTigo: 0, Telecel: 0 };
        let networks = ["MTN", "AirtelTigo", "Telecel"];
        
        // --- DOM ELEMENTS ---
        const shopLinkInput = document.getElementById('shop-link');
        const profitBalanceDisplay = document.getElementById('profit-balance');
        const pricingFormsDiv = document.getElementById('pricing-forms');
        const pricingStatusDiv = document.getElementById('pricing-manager-status');
        const copyLinkBtn = document.getElementById('copy-link-btn');
        const sidebarPayoutBalance = document.getElementById('sidebar-payout-balance');
        const sidebarWalletBalance = document.getElementById('sidebar-wallet-balance');


        // --- UTILITY ---
        function formatCurrency(pesewas) {
            return (pesewas / 100).toFixed(2);
        }

        // --- SIDEBAR LOGIC ---
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const sidebarBackdrop = document.getElementById('sidebar-backdrop');
            sidebar.classList.toggle('open');
            sidebarBackdrop.classList.toggle('hidden');
        }

        // --- DATA FETCHING & UI SETUP ---

        async function fetchAgentData() {
            try {
                const response = await fetch('/api/user-info');
                if (response.status === 401) {
                    window.location.href = '/login.html'; return;
                }
                if (!response.ok) throw new Error('Failed to fetch user data.');

                const data = await response.json();

                if (data.role !== 'Agent') {
                    document.querySelector('.container').innerHTML = '<h1 class="text-center text-xl mt-12">Access Denied: You must be a registered agent.</h1>';
                    return;
                }
                
                // Update global data
                currentShopId = data.shopId;
                
                // Update Wallet Displays
                sidebarWalletBalance.textContent = `GHS ${formatCurrency(data.walletBalance)}`;
                sidebarPayoutBalance.textContent = `Payout: GHS ${formatCurrency(data.payoutWalletBalance)}`;
                profitBalanceDisplay.textContent = `GHS ${formatCurrency(data.payoutWalletBalance)}`;


                if (currentShopId) {
                    const baseUrl = window.location.origin;
                    const shopUrl = `${baseUrl}/agent_shop.html?shopId=${currentShopId}`;
                    shopLinkInput.value = shopUrl;
                    await fetchMarkups();
                } else {
                    shopLinkInput.value = 'Shop not created yet.';
                    pricingStatusDiv.textContent = 'Please create your shop to set markups.';
                }

            } catch (error) {
                showToast('Failed to load dashboard data.', 'error');
                console.error(error);
            }
        }

        async function fetchMarkups() {
            pricingStatusDiv.textContent = 'Loading custom pricing...';
            try {
                const response = await fetch(`/api/agent/get-markups?shopId=${currentShopId}`);
                if (!response.ok) throw new Error('Failed to fetch markups.');

                const data = await response.json();
                currentMarkups = data.customMarkups;
                renderPricingForms();
                pricingStatusDiv.textContent = '';
                
            } catch (error) {
                pricingStatusDiv.textContent = 'Error loading pricing manager.';
                showToast('Error loading pricing data.', 'error');
            }
        }
        
        // --- PRICING RENDER & ACTIONS ---
        
        function renderPricingForms() {
            pricingFormsDiv.innerHTML = '';
            networks.forEach(network => {
                const markup = currentMarkups[network] || 0;
                const formHtml = `
                    <div class="p-4 border border-gray-300 rounded-lg dark:border-gray-700 dark:bg-[#282828]">
                        <h4 class="text-lg font-bold text-primary mb-3">${network}</h4>
                        <p class="text-xs text-gray-500 dark:text-gray-400 mb-2">Wholesale cost: Varies. Min markup: 0.</p>
                        <form onsubmit="handleMarkupUpdate(event, '${network}')">
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300">Markup (Pesewas)</label>
                            <input type="number" name="markup" value="${markup / 100}" step="0.05" min="0" required
                                class="w-full p-2 mt-1 border rounded-lg dark:bg-gray-700 dark:text-white"
                                data-network="${network}" data-markup-pesewas="${markup}">
                            <button type="submit" class="w-full mt-3 py-2 bg-primary text-white rounded-lg hover:bg-secondary transition">
                                Set Price
                            </button>
                        </form>
                    </div>
                `;
                pricingFormsDiv.innerHTML += formHtml;
            });
        }
        
        // ðŸ›‘ CRITICAL FUNCTIONALITY ðŸ›‘
        window.handleMarkupUpdate = async function(event, network) {
            event.preventDefault();
            const form = event.target;
            const input = form.querySelector('input[name="markup"]');
            
            // Convert GHS (float) input to Pesewas (integer)
            const markupGHS = parseFloat(input.value);
            const markupPesewas = Math.round(markupGHS * 100);

            if (markupPesewas < 0) {
                showToast("Markup cannot be negative.", 'error');
                return;
            }

            try {
                const response = await fetch('/api/agent/update-markup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ network, markupValue: markupPesewas })
                });

                const data = await response.json();
                
                if (response.ok) {
                    showToast(data.message, 'success');
                    // Update the local state and re-render
                    currentMarkups[network] = markupPesewas;
                    renderPricingForms();
                } else {
                    showToast(data.message || "Failed to update price.", 'error');
                }
            } catch (error) {
                showToast("Network error: Could not connect to server.", 'error');
            }
        }
        
        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            fetchAgentData();
            
            copyLinkBtn.addEventListener('click', () => {
                const link = shopLinkInput.value;
                navigator.clipboard.writeText(link).then(() => {
                    showToast('Shop link copied to clipboard!', 'success');
                }).catch(err => {
                    showToast('Failed to copy link.', 'error');
                });
            });
            
            // Sidebar listeners
            document.getElementById('open-sidebar').addEventListener('click', toggleSidebar);
            document.getElementById('close-sidebar').addEventListener('click', toggleSidebar);
            document.getElementById('sidebar-backdrop').addEventListener('click', toggleSidebar);
        });
    </script>
</body>
</html>
