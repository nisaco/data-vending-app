<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="apple-touch-icon.png">
    <title>Agent Shop Setup - AJEnterprise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --primary: #009879; --secondary: #007a63; }
        .text-primary { color: var(--primary); }
        .bg-primary { background-color: var(--primary); }
        .hover\:bg-secondary:hover { background-color: var(--secondary); }
        .dark { background-color: #121212; color: #e0e0e0; }
        .dark .bg-white { background-color: #1f1f1f; color: #e0e0e0; }
        .dark input, .dark select { background-color: #374151; border-color: #4b5563; color: #f3f4f6; }
        .dark .border-gray-100 { border-color: #374151; }
        .dark .bg-gray-100 { background-color: #1f1f1f; }
        .dark .text-gray-600 { color: #b0b0b0; }

        #toast-container {
            position: fixed;
            top: 1rem;
            right: 1rem;
            z-index: 1000;
            max-width: 300px;
        }
        .text-blue-600 { color: #2563eb; }
        .bg-blue-100 { background-color: #eff6ff; }
    </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans dark:bg-[#121212] dark:text-gray-200">

    <div id="toast-container"></div>
    
    <nav class="bg-white shadow-lg dark:bg-[#1f1f1f]">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
            <a href="/dashboard.html" class="text-xl font-bold text-primary">DataLink Agent</a>
            <a href="/dashboard.html" class="text-gray-600 dark:text-gray-400 hover:text-primary transition font-medium">Dashboard</a>
        </div>
    </nav>

    <div class="container mx-auto p-4 max-w-2xl">
        <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl mt-8 border border-gray-100 dark:bg-[#1f1f1f] dark:border-gray-700">
            
            <h1 class="text-3xl font-extrabold text-gray-800 dark:text-white mb-2" id="header-text">Agent Shop Setup</h1>
            <p class="text-gray-600 mb-6 dark:text-gray-400" id="sub-header-text">
                Create your personalized shop link and set your data plan markups (in **Pesewas**).
            </p>
            
            <div id="shop-management-area">
                <div class="text-center py-10 text-gray-500">Loading...</div>
            </div>
            
        </div>
    </div>
    
<script>
    // --- TOAST NOTIFICATION SYSTEM ---
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const colors = {
            success: 'bg-green-500 border-green-700',
            error: 'bg-red-500 border-red-700',
            warning: 'bg-yellow-500 border-yellow-700',
        };
        const toast = document.createElement('div');
        toast.className = `p-4 mb-2 text-white text-sm font-semibold rounded-lg shadow-lg border-b-4 ${colors[type]} transform translate-x-full transition-all duration-300 ease-out`;
        toast.textContent = message;

        container.prepend(toast);

        setTimeout(() => {
            toast.style.transform = 'translateX(0)';
        }, 10);

        setTimeout(() => {
            toast.style.transform = 'translateX(120%)';
            setTimeout(() => {
                container.removeChild(toast);
            }, 400);
        }, 6000);
    }
    // --- END TOAST SYSTEM ---

    const managementArea = document.getElementById('shop-management-area');
    const headerText = document.getElementById('header-text');
    const subHeaderText = document.getElementById('sub-header-text');
    let userShopId = null;
    let userRole = null;
    let currentMarkups = {};

    // --- TEMPLATES ---
    const createShopFormHTML = `
        <h2 class="text-xl font-bold mb-4">Create Your Shop</h2>
        <form id="create-shop-form" class="space-y-4">
            <div>
                <label for="shop-name" class="block text-gray-700 dark:text-gray-300">Shop Name</label>
                <input type="text" id="shop-name" required placeholder="e.g., 'Data King Store'"
                       class="w-full p-2 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600">
            </div>
            <button type="submit" class="w-full py-2 px-4 bg-primary text-white font-bold rounded-lg hover:bg-secondary transition">
                Create Shop Now
            </button>
        </form>
    `;

    function renderMarkupManager(shopId, shopName) {
        headerText.textContent = `Manage ${shopName}`;
        subHeaderText.textContent = `Shop ID: ${shopId}. Set your custom markup in Pesewas (100 Pesewas = 1 GHS).`;

        managementArea.innerHTML = `
            <div id="shop-link-card" class="bg-blue-100 border border-blue-300 p-4 rounded-xl mb-6 text-blue-800 dark:bg-blue-900 dark:border-blue-700 dark:text-blue-200">
                <p class="font-medium">Your Public Shop Link:</p>
                <a id="public-shop-link" href="/agent_shop.html?shopId=${shopId}" target="_blank" class="text-blue-600 hover:text-blue-900 font-bold break-all underline dark:text-blue-400">
                    ${window.location.origin}/agent_shop.html?shopId=${shopId}
                </a>
                <button id="copy-shop-link" class="mt-2 text-xs py-1 px-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">Copy Link</button>
            </div>

            <h2 class="text-xl font-bold mb-4 mt-6">Set Network Markups (Pesewas)</h2>
            <div id="markup-forms-container" class="space-y-6">
                </div>
        `;

        document.getElementById('copy-shop-link').addEventListener('click', () => {
            const link = document.getElementById('public-shop-link').href;
            navigator.clipboard.writeText(link).then(() => {
                showToast("Shop link copied!", 'success');
            }).catch(() => {
                showToast("Failed to copy link.", 'error');
            });
        });

        const networks = ["MTN", "AirtelTigo", "Telecel"];
        const formsContainer = document.getElementById('markup-forms-container');
        
        networks.forEach(network => {
            const formDiv = document.createElement('div');
            formDiv.className = 'p-4 border rounded-lg dark:border-gray-700';
            formDiv.innerHTML = `
                <h3 class="text-lg font-semibold mb-2">${network} Markup</h3>
                <form class="update-markup-form flex space-x-3" data-network="${network}">
                    <input type="number" name="markup" min="0" value="${currentMarkups[network] || 0}" required
                           class="flex-grow p-2 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600"
                           placeholder="Markup in Pesewas">
                    <button type="submit" class="py-2 px-4 bg-primary text-white font-bold rounded-lg hover:bg-secondary transition">
                        Update
                    </button>
                </form>
                <div id="plans-for-${network}" class="mt-4 text-sm dark:text-gray-400">Loading plans...</div>
            `;
            formsContainer.appendChild(formDiv);
            fetchPlans(shopId, network);
        });

        // Attach listeners to new forms
        document.querySelectorAll('.update-markup-form').forEach(form => {
            form.addEventListener('submit', handleMarkupUpdate);
        });
    }

    // --- HANDLERS ---

    async function handleCreateShop(e) {
        e.preventDefault();
        const form = e.target;
        const shopName = form.querySelector('#shop-name').value.trim();
        const button = form.querySelector('button[type="submit"]');

        if (!shopName) return showToast('Shop name is required.', 'error');
        
        button.disabled = true;
        button.textContent = 'Creating...';

        try {
            const response = await fetch('/api/agent/create-shop', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ shopName })
            });
            const data = await response.json();

            if (response.ok) {
                showToast(data.message, 'success');
                userShopId = data.shopId;
                // Re-initialize to show the management view
                await initialize();
            } else {
                showToast(data.message || 'Failed to create shop.', 'error');
            }
        } catch (error) {
            showToast('Server error during shop creation.', 'error');
        } finally {
            button.disabled = false;
            button.textContent = 'Create Shop Now';
        }
    }

    async function handleMarkupUpdate(e) {
        e.preventDefault();
        const form = e.target;
        const network = form.dataset.network;
        const markupValue = parseInt(form.querySelector('input[name="markup"]').value, 10);
        const button = form.querySelector('button[type="submit"]');

        if (isNaN(markupValue) || markupValue < 0) {
            return showToast('Markup must be a non-negative number.', 'error');
        }

        button.disabled = true;
        button.textContent = 'Saving...';

        try {
            const response = await fetch('/api/agent/update-markup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ network, markupValue })
            });
            const data = await response.json();

            if (response.ok) {
                showToast(data.message, 'success');
                currentMarkups[network] = markupValue;
                fetchPlans(userShopId, network); // Refresh plans to show new prices
            } else {
                showToast(data.message || 'Failed to update markup.', 'error');
            }
        } catch (error) {
            showToast('Server error during markup update.', 'error');
        } finally {
            button.disabled = false;
            button.textContent = 'Update';
        }
    }

    async function fetchPlans(shopId, network) {
        const plansDiv = document.getElementById(`plans-for-${network}`);
        plansDiv.innerHTML = 'Fetching prices...';
        try {
            const response = await fetch(`/api/agent/plans?shopId=${shopId}&network=${network}`);
            if (!response.ok) throw new Error('Failed to fetch plans');
            const data = await response.json();
            
            if (!currentMarkups[network]) {
                // Infer the currently saved markup from the first plan if not explicitly saved
                const plan = data.plans[0];
                const inferredMarkup = Math.max(0, plan.price - plan.wholesalePrice);
                document.querySelector(`form[data-network="${network}"] input[name="markup"]`).value = inferredMarkup;
                currentMarkups[network] = inferredMarkup;
            }

            const listItems = data.plans.map(p => `
                <li class="flex justify-between">
                    <span>${p.name} (Wholesale: GHS ${(p.wholesalePrice / 100).toFixed(2)})</span>
                    <span class="font-bold text-primary">Selling: GHS ${(p.price / 100).toFixed(2)}</span>
                </li>
            `).join('');

            plansDiv.innerHTML = `
                <ul class="list-disc list-inside space-y-1">
                    ${listItems}
                </ul>
            `;
        } catch (error) {
            plansDiv.innerHTML = 'Could not load plan prices.';
        }
    }


    // --- INITIALIZATION ---
    async function initialize() {
        try {
            const userInfoResponse = await fetch('/api/user-info');
            if (userInfoResponse.status === 401) {
                showToast('Session expired. Redirecting...', 'error');
                return setTimeout(() => window.location.href = '/login.html', 1000);
            }
            const userInfo = await userInfoResponse.json();

            if (userInfo.role !== 'Agent') {
                managementArea.innerHTML = `<p class="text-xl text-red-500 text-center py-10">Access Denied: This page is for Agents only.</p>`;
                return;
            }

            userRole = userInfo.role;
            userShopId = userInfo.shopId;

            if (userShopId) {
                // Shop exists, render management
                const agentShopResponse = await fetch(`/api/agent/plans?shopId=${userShopId}&network=MTN`);
                if (agentShopResponse.status === 404) {
                    showToast('Agent shop data missing. Please try creating a shop.', 'error');
                    managementArea.innerHTML = createShopFormHTML;
                    document.getElementById('create-shop-form').addEventListener('submit', handleCreateShop);
                    return;
                }
                const agentShopData = await agentShopResponse.json();
                
                // Fetch the actual shop name from user-info/another endpoint if needed, for now use a placeholder
                const shopName = userInfo.username ? `${userInfo.username}'s Store` : 'Your Shop'; 

                // We use the markup from the DB in the management view, we can't infer it simply from one network's plan.
                // For simplicity, we'll rely on the server to retrieve the markups on load or re-fetch after a successful update.
                // The current implementation is simpler: we update the form with the markup and rely on `fetchPlans` to populate the calculated prices.
                renderMarkupManager(userShopId, shopName);

            } else {
                // Shop does not exist, render creation form
                managementArea.innerHTML = createShopFormHTML;
                document.getElementById('create-shop-form').addEventListener('submit', handleCreateShop);
            }

        } catch (error) {
            console.error('Initialization error:', error);
            managementArea.innerHTML = `<p class="text-xl text-red-500 text-center py-10">Error loading page data.</p>`;
        }
    }

    document.addEventListener('DOMContentLoaded', initialize);
</script>
</body>
</html>
