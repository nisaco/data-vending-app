<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="icon" type="image/x-icon" href="apple-touch-icon.png">
    <title>Agent Shop Setup - AJEnterprise</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root { --primary: #009879; --secondary: #007a63; }
        .text-primary { color: var(--primary); }
        .bg-primary { background-color: var(--primary); }
        .hover\:bg-secondary:hover { background-color: var(--secondary); }
        
        body { background-color: #121212; color: #e0e0e0; }
        .card { background-color: #1f1f1f; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.4); }
        input, select { background-color: #374151; border-color: #4b5563; color: #e0e0e0; }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 2px rgba(0, 152, 121, 0.5); }

        #toast-container {
            position: fixed; top: 1rem; right: 1rem; z-index: 1000; max-width: 300px;
        }
    </style>
</head>
<body class="min-h-screen font-sans">

    <div id="toast-container"></div>
    
    <nav class="bg-[#1f1f1f] shadow-lg border-b border-gray-700">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
            <a href="/dashboard.html" class="text-xl font-bold text-primary">DataLink Agent</a>
            <a href="/dashboard.html" class="text-gray-400 hover:text-primary transition font-medium">Dashboard</a>
        </div>
    </nav>

    <div class="container mx-auto p-4 max-w-4xl">
        <div class="card p-6 md:p-8 rounded-2xl mt-8 border border-gray-700">
            
            <h1 class="text-3xl font-extrabold text-white mb-2" id="header-text">Agent Shop Setup</h1>
            <p class="text-gray-400 mb-6" id="sub-header-text">
                Set individual markups (in **Pesewas**) for each data package.
            </p>
            
            <div id="shop-management-area">
                <div class="text-center py-10 text-gray-500">Loading...</div>
            </div>
            
        </div>
    </div>
    
<script>
    function showToast(message, type = 'success') {
        const container = document.getElementById('toast-container');
        const colors = { success: 'bg-green-600 border-green-800', error: 'bg-red-600 border-red-800', warning: 'bg-yellow-600 border-yellow-800' };
        const toast = document.createElement('div');
        toast.className = `p-4 mb-2 text-white text-sm font-semibold rounded-lg shadow-lg border-b-4 ${colors[type]} transform translate-x-full transition-all duration-300 ease-out`;
        toast.textContent = message;

        container.prepend(toast);
        setTimeout(() => { toast.style.transform = 'translateX(0)'; }, 10);
        setTimeout(() => { 
            toast.style.transform = 'translateX(120%)';
            setTimeout(() => { container.removeChild(toast); }, 400);
        }, 6000);
    }

    const managementArea = document.getElementById('shop-management-area');
    const headerText = document.getElementById('header-text');
    const subHeaderText = document.getElementById('sub-header-text');
    let userShopId = null;
    let currentPlans = {}; 
    let currentNetwork = 'MTN';

    const createShopFormHTML = `
        <h2 class="text-xl font-bold mb-4 text-white">Create Your Public Shop</h2>
        <form id="create-shop-form" class="space-y-4">
            <div>
                <label for="shop-name" class="block text-gray-400">Shop Name</label>
                <input type="text" id="shop-name" required placeholder="e.g., 'Fast Data Outlet'"
                       class="w-full p-3 border border-gray-600 rounded-xl">
            </div>
            <button type="submit" class="w-full py-3 px-4 bg-primary text-white font-bold rounded-xl hover:bg-secondary transition">
                Create Shop Now
            </button>
        </form>
    `;

    function formatPesewasToGHS(pesewas) {
        return `GHS ${(pesewas / 100).toFixed(2)}`;
    }

    function calculateSellingPrice(wholesale, markup) {
        const raw = wholesale + markup;
        // Ensure price is rounded to nearest 5 pesewas and never below wholesale
        return Math.ceil(Math.max(raw, wholesale) / 5) * 5; 
    }

    function renderMarkupManager(shopId, shopName) {
        headerText.textContent = `Manage ${shopName}`;
        subHeaderText.textContent = `Shop ID: ${shopId}. Set individual markups (in Pesewas) to calculate your selling prices.`;

        managementArea.innerHTML = `
            <div id="shop-link-card" class="bg-[#1e3a8a] border border-blue-700 p-4 rounded-xl mb-6 text-blue-200">
                <p class="font-medium text-white">Your Public Shop Link:</p>
                <a id="public-shop-link" href="${window.location.origin}/agent_shop.html?shopId=${shopId}" target="_blank" class="text-cyan-400 hover:text-cyan-200 font-bold break-all underline text-sm">
                    ${window.location.origin}/agent_shop.html?shopId=${shopId}
                </a>
                <button id="copy-shop-link" class="mt-3 text-xs py-1 px-3 bg-primary text-white rounded-xl hover:bg-secondary transition">Copy Link</button>
            </div>
            
            <div class="flex space-x-3 mb-6">
                <select id="network-selector" class="p-3 border border-gray-600 rounded-xl flex-grow">
                    <option value="MTN">MTN</option>
                    <option value="AirtelTigo">AirtelTigo</option>
                    <option value="Telecel">Telecel</option>
                </select>
            </div>
            
            <h2 class="text-xl font-bold text-white mb-4">Pricing for <span id="current-network-name">MTN</span></h2>
            
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-400">
                    <thead class="text-xs text-white uppercase bg-gray-700 rounded-t-xl">
                        <tr>
                            <th class="py-3 px-4">Package</th>
                            <th class="py-3 px-4">Wholesale Cost (GHS)</th>
                            <th class="py-3 px-4">Markup (Pesewas)</th>
                            <th class="py-3 px-4">Selling Price (GHS)</th>
                            <th class="py-3 px-4 text-center">Action</th>
                        </tr>
                    </thead>
                    <tbody id="plans-table-body" class="divide-y divide-gray-700">
                        <!-- Plans loaded here -->
                    </tbody>
                </table>
            </div>
        `;

        document.getElementById('copy-shop-link').addEventListener('click', () => {
            const link = document.getElementById('public-shop-link').href;
            navigator.clipboard.writeText(link).then(() => {
                showToast("Shop link copied!", 'success');
            });
        });

        const selector = document.getElementById('network-selector');
        selector.addEventListener('change', (e) => {
            currentNetwork = e.target.value;
            document.getElementById('current-network-name').textContent = currentNetwork;
            fetchPlans(userShopId, currentNetwork);
        });

        // Initial load
        fetchPlans(shopId, currentNetwork);
    }

    async function fetchPlans(shopId, network) {
        const tableBody = document.getElementById('plans-table-body');
        tableBody.innerHTML = `<tr><td colspan="5" class="py-4 text-center text-gray-500">Loading plans for ${network}...</td></tr>`;
        
        try {
            const response = await fetch(`/api/agent/plans?shopId=${shopId}&network=${network}`);
            if (!response.ok) throw new Error('Failed to fetch plans');
            const data = await response.json();
            
            currentPlans = {};
            tableBody.innerHTML = '';

            data.plans.forEach(p => {
                // Store plan data including markup (markup is read from DB by server)
                const markup = p.price - p.wholesalePrice;
                currentPlans[p.id] = { ...p, markup: markup };
                
                const sellingPrice = calculateSellingPrice(p.wholesalePrice, markup);

                const row = tableBody.insertRow();
                row.className = 'hover:bg-gray-800 transition duration-150';
                
                row.innerHTML = `
                    <td class="py-3 px-4 font-semibold text-white">${p.name} (${p.id}GB)</td>
                    <td class="py-3 px-4">${formatPesewasToGHS(p.wholesalePrice)}</td>
                    <td class="py-3 px-4">
                        <input type="number" min="0" value="${Math.max(0, markup)}" data-id="${p.id}"
                               class="markup-input markup-input-${p.id} w-20 p-2 text-center border border-gray-600 rounded-lg text-sm"
                               placeholder="Pesewas">
                    </td>
                    <td class="py-3 px-4 text-primary font-bold selling-price-${p.id}">
                        ${formatPesewasToGHS(sellingPrice)}
                    </td>
                    <td class="py-3 px-4 text-center">
                        <button type="button" data-id="${p.id}"
                               class="update-plan-btn update-plan-btn-${p.id} py-1 px-3 bg-primary text-white text-xs font-medium rounded-xl hover:bg-secondary transition">
                            Save
                        </button>
                    </td>
                `;
            });
            
            // ðŸ›‘ FIX 1: Attach input change listener using the unique ID selector ðŸ›‘
            document.querySelectorAll('.markup-input').forEach(input => {
                const id = input.dataset.id;
                const sellingPriceDisplay = document.querySelector(`.selling-price-${id}`);
                
                input.addEventListener('input', (e) => {
                    const markup = parseInt(e.target.value) || 0;
                    const wholesale = currentPlans[id].wholesalePrice;
                    const newSellingPrice = calculateSellingPrice(wholesale, markup);
                    sellingPriceDisplay.textContent = formatPesewasToGHS(newSellingPrice);
                });
            });

            // Attach save button listener
            document.querySelectorAll('.update-plan-btn').forEach(button => {
                button.addEventListener('click', handleIndividualMarkupUpdate);
            });


        } catch (error) {
            tableBody.innerHTML = `<tr><td colspan="5" class="py-4 text-center text-red-500">Error loading prices: ${error.message}</td></tr>`;
        }
    }

    async function handleIndividualMarkupUpdate(e) {
        const button = e.target;
        const capacityId = button.dataset.id;
        
        // ðŸ›‘ FIX 2: Correctly retrieve the value from the specific input using its unique class ðŸ›‘
        const input = document.querySelector(`.markup-input-${capacityId}`);
        const markupValue = parseInt(input.value) || 0;

        if (isNaN(markupValue) || markupValue < 0) {
            return showToast('Markup must be a non-negative number.', 'error');
        }

        button.disabled = true;
        button.textContent = 'Saving...';
        
        const wholesale = currentPlans[capacityId].wholesalePrice;
        if (wholesale + markupValue < wholesale) {
             return showToast('Markup cannot result in a price below wholesale.', 'error');
        }


        try {
            const response = await fetch('/api/agent/update-markup', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    network: currentNetwork, 
                    capacityId: capacityId, 
                    markupValue: markupValue 
                })
            });
            const data = await response.json();

            if (response.ok) {
                showToast(data.message, 'success');
                // Re-fetch plans to refresh the table state
                fetchPlans(userShopId, currentNetwork); 
            } else {
                showToast(data.message || 'Failed to update markup.', 'error');
            }
        } catch (error) {
            showToast('Server error during markup update.', 'error');
        } finally {
            button.disabled = false;
            button.textContent = 'Save';
        }
    }


    async function handleCreateShop(e) {
        e.preventDefault();
        const form = e.target;
        const shopName = form.querySelector('#shop-name').value.trim();
        const button = form.querySelector('button[type="submit"]');

        if (!shopName) return showToast('Shop name is required.', 'error');
        
        button.disabled = true;
        button.textContent = 'Creating...';

        try {
            const response = await fetch('/api/agent/create-shop', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ shopName })
            });
            const data = await response.json();

            if (response.ok) {
                showToast(data.message, 'success');
                userShopId = data.shopId;
                await initialize();
            } else {
                showToast(data.message || 'Failed to create shop.', 'error');
            }
        } catch (error) {
            showToast('Server error during shop creation.', 'error');
        } finally {
            button.disabled = false;
            button.textContent = 'Create Shop Now';
        }
    }

    async function initialize() {
        try {
            const userInfoResponse = await fetch('/api/user-info');
            if (userInfoResponse.status === 401) {
                showToast('Session expired. Redirecting...', 'error');
                return setTimeout(() => window.location.href = '/login.html', 1000);
            }
            
            const userInfo = await userInfoResponse.json();
            
            if (!userInfo || !userInfo.username) {
                managementArea.innerHTML = `<p class="text-xl text-red-500 text-center py-10">Error: Could not retrieve user data.</p>`;
                return;
            }

            userShopId = userInfo.shopId;

            if (userShopId) {
                const agentShopResponse = await fetch(`/api/agent/plans?shopId=${userShopId}&network=MTN`);
                
                if (agentShopResponse.status === 404) {
                    showToast('Agent shop data missing. Please proceed to create one.', 'warning');
                    managementArea.innerHTML = createShopFormHTML;
                    document.getElementById('create-shop-form').addEventListener('submit', handleCreateShop);
                    return;
                }
                
                const agentShopData = await agentShopResponse.json();
                
                if (!agentShopResponse.ok) {
                    const errorData = agentShopData;
                    showToast(errorData.message || 'Failed to load shop configurations.', 'error');
                    managementArea.innerHTML = `<p class="text-xl text-red-500 text-center py-10">Error loading shop data: ${errorData.message}</p>`;
                    return;
                }
                
                const shopName = agentShopData.shopName || `${userInfo.username}'s Store`; 
                renderMarkupManager(userShopId, shopName);

            } else {
                managementArea.innerHTML = createShopFormHTML;
                document.getElementById('create-shop-form').addEventListener('submit', handleCreateShop);
            }

        } catch (error) { 
            console.error('Initialization Fatal Error:', error);
            showToast('A critical error occurred during initialization.', 'error');
            managementArea.innerHTML = `<p class="text-xl text-red-500 text-center py-10">A network or server error occurred during page load.</p>`;
        }
    }

    document.addEventListener('DOMContentLoaded', initialize);
</script>
</body>
</html>
