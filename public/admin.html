<!DOCTYPE html>
<html lang="en">
<head>
Â  Â  <meta charset="UTF-8">
Â  Â  <meta name="viewport" content="width=device-width, initial-scale=1.0">
Â  Â  <link rel="icon" type="image/x-icon" href="apple-touch-icon.png">
Â  Â  <title>Admin Dashboard - Executive Management</title>
Â  Â  <script src="https://cdn.tailwindcss.com"></script>
Â  Â  <style>
Â  Â  Â  Â  /* Professional Color Palette */
Â  Â  Â  Â  :root { 
Â  Â  Â  Â  Â  Â  --primary: #009879; 
Â  Â  Â  Â  Â  Â  --secondary: #007a63; 
Â  Â  Â  Â  Â  Â  --text-dark: #1f2937;
Â  Â  Â  Â  Â  Â  --text-light: #f9fafb;
Â  Â  Â  Â  }
Â  Â  Â  Â  .text-primary { color: var(--primary); }
Â  Â  Â  Â  .bg-primary { background-color: var(--primary); }
Â  Â  Â  Â  .hover\:bg-secondary:hover { background-color: var(--secondary); }
Â  Â  Â  Â  
Â  Â  Â  Â  /* Dashboard Card Styles */
Â  Â  Â  Â  .metric-card {
Â  Â  Â  Â  Â  Â  background-color: #ffffff;
Â  Â  Â  Â  Â  Â  border-radius: 0.75rem;
Â  Â  Â  Â  Â  Â  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.06);
Â  Â  Â  Â  Â  Â  transition: all 0.2s ease-in-out;
Â  Â  Â  Â  }
Â  Â  Â  Â  .metric-card:hover {
Â  Â  Â  Â  Â  Â  transform: translateY(-2px);
Â  Â  Â  Â  Â  Â  box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -4px rgba(0, 0, 0, 0.05);
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Status Pill Colors */
Â  Â  Â  Â  .status-data_sent, .status-topup_successful { background-color: #10b981; } /* Green */
Â  Â  Â  Â  .status-pending_review { background-color: #f59e0b; } /* Orange */
Â  Â  Â  Â  .status-data_failed, .status-payment_failed { background-color: #ef4444; } /* Red */
Â  Â  Â  Â  .status-payment_success { background-color: #3b82f6; } /* Blue */
Â  Â  Â  Â  
Â  Â  Â  Â  /* ðŸ›‘ WITHDRAWAL STATUS COLORS ðŸ›‘ */
Â  Â  Â  Â  .status-withdrawal_pending { background-color: #f59e0b; } /* Orange for pending action */
Â  Â  Â  Â  .status-withdrawal_sent { background-color: #3b82f6; } /* Blue/Completed */

Â  Â  Â  Â  /* Client Status Colors */
Â  Â  Â  Â  .status-online { background-color: #10b981; }
Â  Â  Â  Â  .status-offline { background-color: #6b7280; }

Â  Â  Â  Â  /* Tab Styles */
Â  Â  Â  Â  .admin-tab {
Â  Â  Â  Â  Â  Â  padding: 10px 20px;
Â  Â  Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  Â  Â  font-weight: 500;
Â  Â  Â  Â  Â  Â  border-bottom: 2px solid transparent;
Â  Â  Â  Â  Â  Â  transition: all 0.2s;
Â  Â  Â  Â  }
Â  Â  Â  Â  .admin-tab.active {
Â  Â  Â  Â  Â  Â  color: var(--primary);
Â  Â  Â  Â  Â  Â  font-weight: 700;
Â  Â  Â  Â  Â  Â  border-bottom: 2px solid var(--primary);
Â  Â  Â  Â  }

Â  Â  Â  Â  /* Dark Mode Overrides */
Â  Â  Â  Â  .dark { background-color: #121212; color: #e0e0e0; }
Â  Â  Â  Â  .dark .bg-white, .dark .metric-card { background-color: #1f1f1f; border-color: #374151; }
Â  Â  Â  Â  .dark .text-gray-800 { color: #ffffff; }
Â  Â  Â  Â  .dark .text-gray-500 { color: #9ca3af; }
Â  Â  Â  Â  .dark .bg-gray-100 { background-color: #374151; }
Â  Â  Â  Â  .dark input, .dark select { background-color: #374151; border-color: #4b5563; color: #e0e0e0; }
Â  Â  Â  Â  .dark .bg-gray-200 { background-color: #374151; }

Â  Â  Â  Â  /* Modal Backdrop */
Â  Â  Â  Â  #modal-backdrop, #delete-confirm-modal-backdrop, #role-modal-backdrop {
Â  Â  Â  Â  Â  Â  background-color: rgba(0, 0, 0, 0.75);
Â  Â  Â  Â  Â  Â  transition: opacity 0.3s ease;
Â  Â  Â  Â  Â  Â  z-index: 50;
Â  Â  Â  Â  }
Â  Â  Â  Â  /* Toast Container for Notifications */
Â  Â  Â  Â  #toast-container {
Â  Â  Â  Â  Â  Â  position: fixed;
Â  Â  Â  Â  Â  Â  top: 1rem;
Â  Â  Â  Â  Â  Â  right: 1rem;
Â  Â  Â  Â  Â  Â  z-index: 1000;
Â  Â  Â  Â  Â  Â  max-width: 300px;
Â  Â  Â  Â  }
Â  Â  </style>
</head>
<body class="bg-gray-50 min-h-screen font-sans transition-colors duration-300 dark:bg-[#121212] dark:text-gray-200">

Â  Â  <div id="toast-container"></div>
Â  Â  
Â  Â  Â  Â  <div id="modal-backdrop" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-75 z-50 opacity-0 transition-opacity duration-300">
Â  Â  Â  Â  <div id="status-modal" class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md transform scale-95 transition-all duration-300 dark:bg-gray-800">
Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Update Order Status</h3>
Â  Â  Â  Â  Â  Â  <div id="modal-current-order" class="text-sm text-gray-600 dark:text-gray-400 mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Reference: <span id="modal-order-ref" class="font-medium"></span>
Â  Â  Â  Â  Â  Â  Â  Â  <br> Current Status: <span id="modal-current-status" class="font-bold"></span>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="modal-payout-details" class="text-sm text-blue-500 font-semibold mt-2 hidden">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Payout To: <span id="modal-payout-account"></span>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <label for="new-status" class="block text-gray-700 dark:text-gray-300 mb-2">New Status</label>
Â  Â  Â  Â  Â  Â  <select id="new-status" class="w-full p-2 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="data_sent">Data Sent (Fulfilled)</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="pending_review">Pending Review</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="data_failed">Data Failed</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="payment_failed">Payment Failed</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="withdrawal_pending">Awaiting Payout (Manual Action)</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="withdrawal_sent">Payout Sent (Completed)</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  <div id="modal-status-message" class="mt-3 text-sm font-medium text-red-500"></div>

Â  Â  Â  Â  Â  Â  <div class="mt-6 flex justify-end space-x-3">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="modal-cancel" type="button" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600">Cancel</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="modal-update" type="button" class="py-2 px-4 bg-primary text-white rounded-lg hover:bg-secondary transition">Update</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>

Â  Â  Â  Â  <div id="delete-confirm-modal-backdrop" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-75 z-50 opacity-0 transition-opacity duration-300">
Â  Â  Â  Â  <div id="delete-confirm-modal" class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-sm transform scale-95 transition-all duration-300 dark:bg-gray-800">
Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-bold text-red-500 mb-4">Confirm Deletion</h3>
Â  Â  Â  Â  Â  Â  <p class="text-gray-700 dark:text-gray-300 mb-6">
Â  Â  Â  Â  Â  Â  Â  Â  Are you sure you want to permanently delete user 
Â  Â  Â  Â  Â  Â  Â  Â  <span id="delete-username-display" class="font-bold text-red-500"></span>? 
Â  Â  Â  Â  Â  Â  Â  Â  This action is irreversible and will delete ALL associated orders.
Â  Â  Â  Â  Â  Â  </p>

Â  Â  Â  Â  Â  Â  <div class="mt-4 flex justify-end space-x-3">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="delete-modal-cancel" type="button" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600">Cancel</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="delete-modal-confirm" type="button" class="py-2 px-4 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">Delete Permanently</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  
Â  Â  Â  Â  <div id="role-modal-backdrop" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-75 z-50 opacity-0 transition-opacity duration-300">
Â  Â  Â  Â  <div id="role-modal" class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md transform scale-95 transition-all duration-300 dark:bg-gray-800">
Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Change User Role</h3>
Â  Â  Â  Â  Â  Â  <div class="text-sm text-gray-600 dark:text-gray-400 mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  User: <span id="role-modal-username" class="font-bold"></span>
Â  Â  Â  Â  Â  Â  Â  Â  <br> Current Role: <span id="role-modal-current-role" class="font-bold text-primary"></span>
Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  <label for="new-role" class="block text-gray-700 dark:text-gray-300 mb-2">New Role</label>
Â  Â  Â  Â  Â  Â  <select id="new-role" class="w-full p-2 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Client">Client</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Agent">Agent</option>
Â  Â  Â  Â  Â  Â  Â  Â  <option value="Admin">Admin</option>
Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  <div id="role-modal-message" class="mt-3 text-sm font-medium text-red-500"></div>

Â  Â  Â  Â  Â  Â  <div class="mt-6 flex justify-end space-x-3">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="role-modal-cancel" type="button" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600">Cancel</button>
Â  Â  Â  Â  Â  Â  Â  Â  <button id="role-modal-update" type="button" class="py-2 px-4 bg-primary text-white rounded-lg hover:bg-secondary transition">Update Role</button>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </div>
Â  Â  
Â  Â  <nav class="bg-white shadow-lg dark:bg-[#1f1f1f]">
Â  Â  Â  Â  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 flex justify-between items-center h-16">
Â  Â  Â  Â  Â  Â  <a href="/admin.html?secret=YOUR_ADMIN_SECRET" class="text-xl font-bold text-primary">Admin Control Panel</a>
Â  Â  Â  Â  Â  Â  <div class="flex space-x-4 items-center">
Â  Â  Â  Â  Â  Â  Â  Â  <button id="theme-toggle" class="p-2 rounded-full text-gray-500 hover:bg-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 transition">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg id="theme-icon-moon" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path stroke-linecap="round" stroke-linejoin="round" d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <svg id="theme-icon-sun" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </svg>
Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  <p id="admin-key-display" class="text-xs text-gray-400 dark:text-gray-500 hidden sm:block">Key: ---</p>
Â  Â  Â  Â  Â  Â  Â  Â  <a href="/purchase.html" class="py-1 px-3 bg-primary text-white font-bold rounded-lg transition hover:bg-secondary">Go to Client View</a>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>
Â  Â  </nav>

Â  Â  <div class="container mx-auto p-4 max-w-7xl">
Â  Â  Â  Â  <h1 class="text-3xl font-extrabold text-gray-800 dark:text-white mt-4 mb-8">System Overview</h1>

Â  Â  Â  Â  <div id="metrics-container" class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-4">
Â  Â  Â  Â  Â  Â  <div class="metric-card p-5 dark:border-gray-700">
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Revenue</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p id="metric-revenue" class="text-3xl font-extrabold text-gray-800 dark:text-white mt-1">GHS 0.00</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="metric-card p-5 dark:border-gray-700">
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm font-medium text-gray-500 dark:text-gray-400">My Profit</p> Â  Â  Â  Â  Â  Â  Â  Â  <p id="metric-profit" class="text-3xl font-extrabold text-primary mt-1">GHS 0.00</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="metric-card p-5 dark:border-gray-700">
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Orders</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p id="metric-orders" class="text-3xl font-extrabold text-gray-800 dark:text-white mt-1">0</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  <div class="metric-card p-5 dark:border-gray-700">
Â  Â  Â  Â  Â  Â  Â  Â  <p class="text-sm font-medium text-gray-500 dark:text-gray-400">Total Users</p>
Â  Â  Â  Â  Â  Â  Â  Â  <p id="metric-users" class="text-3xl font-extrabold text-gray-800 dark:text-white mt-1">0</p>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="flex justify-start mb-6">
Â  Â  Â  Â  Â  Â  <button id="resetMetricsBtn" class="w-full sm:w-auto py-2 px-4 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition text-sm">
Â  Â  Â  Â  Â  Â  Â  Â  ðŸ”„ Reset Metrics
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>

Â  Â  Â  Â  <div class="flex flex-col sm:flex-row gap-3 mb-6 items-center justify-center">
Â  Â  Â  Â  Â  Â  <input type="password" id="adminSecret" placeholder="Enter Admin Secret" class="w-full sm:w-64 p-3 border border-gray-300 rounded-lg focus:ring-primary focus:border-primary dark:bg-gray-700 dark:border-gray-600 dark:text-white">
Â  Â  Â  Â  Â  Â  <button id="fetchDataBtn" class="w-full sm:w-auto py-3 px-6 bg-primary text-white font-bold rounded-lg hover:bg-secondary transition">
Â  Â  Â  Â  Â  Â  Â  Â  Fetch All Data
Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  </div>


Â  Â  Â  Â  <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl border border-gray-100 dark:bg-[#1f1f1f] dark:border-gray-700">
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  <div class="flex border-b border-gray-200 dark:border-gray-700 mb-6">
Â  Â  Â  Â  Â  Â  Â  Â  <div class="admin-tab active" data-tab="transactions">All Transactions</div>
Â  Â  Â  Â  Â  Â  Â  Â  <div class="admin-tab" data-tab="clients">Client Engagement</div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  <div id="tab-content-transactions">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4 flex justify-between items-center">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  All Transactions
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="status-filter" class="p-2 border border-gray-300 rounded-lg text-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="All">Filter by Status (All)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="withdrawal_pending">Payout Pending (Action Required)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="pending_review">Data Pending (Action Required)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="data_sent">Data Sent (Success)</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="data_failed">Data Failed</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="topup_successful">Top Up Success</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="payment_failed">Payment Failed</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  </h2>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="orders-status" class="text-center font-medium mb-4 text-gray-700 dark:text-gray-400">Enter secret to load data.</div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="overflow-x-auto rounded-xl border border-gray-200 shadow-inner dark:border-gray-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead class="text-xs text-white uppercase bg-primary">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th scope="col" class="py-3 px-6 rounded-tl-xl">Time</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th scope="col" class="py-3 px-6">User</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th scope="col" class="py-3 px-6">Phone / Account</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th scope="col" class="py-3 px-6">Item / Network</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th scope="col" class="py-3 px-6">Amount (GHS)</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th scope="col" class="py-3 px-6">Status</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th scope="col" class="py-3 px-6 rounded-tr-xl">Actions</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="ordersTableBody" class="bg-white divide-y divide-gray-100 dark:bg-[#1f1f1f] dark:divide-gray-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr><td colspan="7" class="py-4 text-center text-gray-400">Data requires authentication.</td></tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div> <div id="tab-content-clients" class="hidden">
Â  Â  Â  Â  Â  Â  Â  Â  <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Client Engagement</h2>
Â  Â  Â  Â  Â  Â  Â  Â  <div id="clients-status" class="text-center font-medium mb-4 text-gray-700 dark:text-gray-400">Enter secret to load client data.</div>

Â  Â  Â  Â  Â  Â  Â  Â  <div class="overflow-x-auto rounded-xl border border-gray-200 shadow-inner dark:border-gray-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <table class="w-full text-sm text-left text-gray-500 dark:text-gray-400">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <thead class="text-xs text-white uppercase bg-primary">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th scope="col" class="py-3 px-6 rounded-tl-xl">Username</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th scope="col" class="py-3 px-6">Email</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th scope="col" class="py-3 px-6">Role</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th scope="col" class="py-3 px-6">Online Status</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th scope="col" class="py-3 px-6">Joined</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th scope="col" class="py-3 px-6">Change Role</th> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <th scope="col" class="py-3 px-6 rounded-tr-xl">Delete</th>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tr>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </thead>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tbody id="clientsTableBody" class="bg-white divide-y divide-gray-100 dark:bg-[#1f1f1f] dark:divide-gray-700">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <tr><td colspan="7" class="py-4 text-center text-gray-400">Client data requires authentication.</td></tr> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </tbody>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </table>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div> </div>
Â  Â  </div>

Â  Â  <script>
Â  Â  Â  Â  // --- TOAST NOTIFICATION SYSTEM ---
Â  Â  Â  Â  function showToast(message, type = 'success') {
Â  Â  Â  Â  Â  Â  const container = document.getElementById('toast-container');
Â  Â  Â  Â  Â  Â  const colors = {
Â  Â  Â  Â  Â  Â  Â  Â  success: 'bg-green-500 border-green-700',
Â  Â  Â  Â  Â  Â  Â  Â  error: 'bg-red-500 border-red-700',
Â  Â  Â  Â  Â  Â  Â  Â  warning: 'bg-yellow-500 border-yellow-700',
Â  Â  Â  Â  Â  Â  };
Â  Â  Â  Â  Â  Â  const toast = document.createElement('div');
Â  Â  Â  Â  Â  Â  toast.className = `p-4 mb-2 text-white text-sm font-semibold rounded-lg shadow-lg border-b-4 ${colors[type]} transform translate-x-full transition-all duration-300 ease-out`;
Â  Â  Â  Â  Â  Â  toast.textContent = message;

Â  Â  Â  Â  Â  Â  // Animate in
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  toast.style.transform = 'translateX(0)';
Â  Â  Â  Â  Â  Â  }, 10);

Â  Â  Â  Â  Â  Â  // Animate out and remove
Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  toast.style.transform = 'translateX(120%)';
Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  container.removeChild(toast);
Â  Â  Â  Â  Â  Â  Â  Â  }, 400);
Â  Â  Â  Â  Â  Â  }, 6000);
Â  Â  Â  Â  }
Â  Â  Â  Â  // --- END TOAST SYSTEM ---

Â  Â  Â  Â  // --- THEME LOGIC START ---
Â  Â  Â  Â  const htmlElement = document.documentElement;
Â  Â  Â  Â  const toggleButton = document.getElementById('theme-toggle');

Â  Â  Â  Â  function applyTheme(theme) {
Â  Â  Â  Â  Â  Â  const isDark = theme === 'dark';
Â  Â  Â  Â  Â  Â  const moonIcon = document.getElementById('theme-icon-moon');
Â  Â  Â  Â  Â  Â  const sunIcon = document.getElementById('theme-icon-sun');

Â  Â  Â  Â  Â  Â  if (isDark) {
Â  Â  Â  Â  Â  Â  Â  Â  htmlElement.classList.add('dark');
Â  Â  Â  Â  Â  Â  Â  Â  moonIcon.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  sunIcon.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  htmlElement.classList.remove('dark');
Â  Â  Â  Â  Â  Â  Â  Â  moonIcon.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  sunIcon.classList.add('hidden');
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  const savedTheme = localStorage.getItem('theme');
Â  Â  Â  Â  if (savedTheme) {
Â  Â  Â  Â  Â  Â  applyTheme(savedTheme);
Â  Â  Â  Â  } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
Â  Â  Â  Â  Â  Â  applyTheme('dark');
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  applyTheme('light');
Â  Â  Â  Â  }

Â  Â  Â  Â  toggleButton.addEventListener('click', () => {
Â  Â  Â  Â  Â  Â  const newTheme = htmlElement.classList.contains('dark') ? 'light' : 'dark';
Â  Â  Â  Â  Â  Â  localStorage.setItem('theme', newTheme);
Â  Â  Â  Â  Â  Â  applyTheme(newTheme);
Â  Â  Â  Â  });
Â  Â  Â  Â  // --- THEME LOGIC END ---

Â  Â  Â  Â  // --- GLOBAL STATE & CONSTANTS ---
Â  Â  Â  Â  let adminSecret = ''; // This will be set from the input field
Â  Â  Â  Â  let allOrders = [];
Â  Â  Â  Â  let allUsers = [];
Â  Â  Â  Â  const statusMap = {
Â  Â  Â  Â  Â  Â  'data_sent': 'Data Sent', 
Â  Â  Â  Â  Â  Â  'pending_review': 'Pending Review', 
Â  Â  Â  Â  Â  Â  'data_failed': 'Data Failed', 
Â  Â  Â  Â  Â  Â  'topup_successful': 'Top Up Success', 
Â  Â  Â  Â  Â  Â  'payment_success': 'Payment Success', 
Â  Â  Â  Â  Â  Â  'payment_failed': 'Payment Failed',
Â  Â  Â  Â  Â  Â  'withdrawal_pending': 'Payout Pending',
Â  Â  Â  Â  Â  Â  'withdrawal_sent': 'Payout Sent'
Â  Â  Â  Â  };

Â  Â  Â  Â  // --- DOM Elements ---
Â  Â  Â  Â  const ordersTableBody = document.getElementById('ordersTableBody');
Â  Â  Â  Â  const ordersStatusDiv = document.getElementById('orders-status');
Â  Â  Â  Â  const clientsTableBody = document.getElementById('clientsTableBody');
Â  Â  Â  Â  const clientsStatusDiv = document.getElementById('clients-status');
Â  Â  Â  Â  const adminSecretInput = document.getElementById('adminSecret');
Â  Â  Â  Â  const fetchDataBtn = document.getElementById('fetchDataBtn');
Â  Â  Â  Â  const resetMetricsBtn = document.createElement('button'); // ðŸ›‘ New Button Element ðŸ›‘
Â  Â  Â  Â  resetMetricsBtn.id = 'resetMetricsBtn';
Â  Â  Â  Â  resetMetricsBtn.className = 'w-full sm:w-auto py-2 px-4 bg-red-500 text-white font-bold rounded-lg hover:bg-red-600 transition text-sm';
Â  Â  Â  Â  resetMetricsBtn.innerHTML = 'ðŸ”„ Reset Metrics';

Â  Â  Â  Â  const metricsContainer = document.getElementById('metrics-container');
Â  Â  Â  Â  const resetContainer = document.createElement('div');
Â  Â  Â  Â  resetContainer.className = 'flex justify-start mb-6';
Â  Â  Â  Â  resetContainer.appendChild(resetMetricsBtn);
Â  Â  Â  Â  metricsContainer.parentNode.insertBefore(resetContainer, metricsContainer.nextSibling);

Â  Â  Â  Â  
Â  Â  Â  Â  const tabsContainer = document.querySelector('.flex.border-b');
Â  Â  Â  Â  const tabContentTransactions = document.getElementById('tab-content-transactions');
Â  Â  Â  Â  const tabContentClients = document.getElementById('tab-content-clients');
Â  Â  Â  Â  const statusFilter = document.getElementById('status-filter');

Â  Â  Â  Â  const metrics = {
Â  Â  Â  Â  Â  Â  revenue: document.getElementById('metric-revenue'), profit: document.getElementById('metric-profit'),
Â  Â  Â  Â  Â  Â  orders: document.getElementById('metric-orders'), users: document.getElementById('metric-users'),
Â  Â  Â  Â  };
Â  Â  Â  Â  // Update "Net Profit" label
Â  Â  Â  Â  document.querySelector('#metrics-container > div:nth-child(2) > p:nth-child(1)').textContent = 'My Profit';
Â  Â  Â  Â  
Â  Â  Â  Â  const modalBackdrop = document.getElementById('modal-backdrop');
Â  Â  Â  Â  const modalStatusMessage = document.getElementById('modal-status-message');
Â  Â  Â  Â  
Â  Â  Â  Â  // Order Update Modal specific elements
Â  Â  Â  Â  const modalOrderRef = document.getElementById('modal-order-ref');
Â  Â  Â  Â  const modalCurrentStatus = document.getElementById('modal-current-status');
Â  Â  Â  Â  const modalUpdateBtn = document.getElementById('modal-update');
Â  Â  Â  Â  const modalCancelBtn = document.getElementById('modal-cancel');
Â  Â  Â  Â  const modalNewStatus = document.getElementById('new-status');
Â  Â  Â  Â  const modalPayoutDetails = document.getElementById('modal-payout-details');
Â  Â  Â  Â  const modalPayoutAccount = document.getElementById('modal-payout-account');

Â  Â  Â  Â  // Delete Modal Elements
Â  Â  Â  Â  const deleteBackdrop = document.getElementById('delete-confirm-modal-backdrop');
Â  Â  Â  Â  const deleteUsernameDisplay = document.getElementById('delete-username-display');
Â  Â  Â  Â  let currentDeleteUserId = null;
Â  Â  Â  Â  
Â  Â  Â  Â  // ðŸ›‘ Role Modal Elements ðŸ›‘
Â  Â  Â  Â  // Injecting the new Role Modal HTML structure before the script block for modal control
Â  Â  Â  Â  const roleModalHtml = `
Â  Â  Â  Â  Â  Â  <div id="role-modal-backdrop" class="fixed inset-0 hidden items-center justify-center bg-black bg-opacity-75 z-50 opacity-0 transition-opacity duration-300">
Â  Â  Â  Â  Â  Â  Â  Â  <div id="role-modal" class="bg-white p-6 rounded-xl shadow-2xl w-full max-w-md transform scale-95 transition-all duration-300 dark:bg-gray-800">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <h3 class="text-xl font-bold text-gray-800 dark:text-white mb-4">Change User Role</h3>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="text-sm text-gray-600 dark:text-gray-400 mb-4">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  User: <span id="role-modal-username" class="font-bold"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <br> Current Role: <span id="role-modal-current-role" class="font-bold text-primary"></span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <label for="new-role" class="block text-gray-700 dark:text-gray-300 mb-2">New Role</label>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <select id="new-role" class="w-full p-2 border border-gray-300 rounded-lg dark:bg-gray-700 dark:border-gray-600 dark:text-white">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Client">Client</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Agent">Agent</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <option value="Admin">Admin</option>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div id="role-modal-message" class="mt-3 text-sm font-medium text-red-500"></div>

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <div class="mt-6 flex justify-end space-x-3">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="role-modal-cancel" type="button" class="py-2 px-4 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition dark:bg-gray-700 dark:text-white dark:hover:bg-gray-600">Cancel</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button id="role-modal-update" type="button" class="py-2 px-4 bg-primary text-white rounded-lg hover:bg-secondary transition">Update Role</button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  Â  Â  </div>
Â  Â  Â  Â  `;
Â  Â  Â  Â  // Append the new modal structure to the body
Â  Â  Â  Â  document.body.insertAdjacentHTML('beforeend', roleModalHtml);

Â  Â  Â  Â  const roleModalBackdrop = document.getElementById('role-modal-backdrop');
Â  Â  Â  Â  const roleModalUsername = document.getElementById('role-modal-username');
Â  Â  Â  Â  const roleModalCurrentRole = document.getElementById('role-modal-current-role');
Â  Â  Â  Â  const roleModalNewRole = document.getElementById('new-role');
Â  Â  Â  Â  const roleModalUpdateBtn = document.getElementById('role-modal-update');
Â  Â  Â  Â  const roleModalCancelBtn = document.getElementById('role-modal-cancel');
Â  Â  Â  Â  const roleModalMessage = document.getElementById('role-modal-message');
Â  Â  Â  Â  let currentRoleUserId = null;


Â  Â  Â  Â  // --- UTILITY FUNCTIONS ---
Â  Â  Â  Â  function safeDateFormatter(isoString) {
Â  Â  Â  Â  Â  Â  if (!isoString) return 'N/A';
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const date = new Date(isoString); 
Â  Â  Â  Â  Â  Â  Â  Â  if (isNaN(date.getTime())) return 'Invalid Date';
Â  Â  Â  Â  Â  Â  Â  Â  return date.toLocaleString('en-GB', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  return 'Invalid Date';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- FETCHING FUNCTIONS ---

Â  Â  Â  Â  async function fetchMetrics() {
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const secret = adminSecretInput.value.trim();
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(`/api/admin/metrics?secret=${secret}`);
Â  Â  Â  Â  Â  Â  Â  Â  const userCountResponse = await fetch(`/api/admin/user-count?secret=${secret}`);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (response.status === 403 || userCountResponse.status === 403) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error('Authorization Failed. Check Admin Secret.');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok || !userCountResponse.ok) throw new Error('Failed to fetch metrics data.');

Â  Â  Â  Â  Â  Â  Â  Â  const metricsData = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  const userData = await userCountResponse.json();

Â  Â  Â  Â  Â  Â  Â  Â  metrics.revenue.textContent = `GHS ${parseFloat(metricsData.revenue).toFixed(2)}`;
Â  Â  Â  Â  Â  Â  Â  Â  metrics.profit.textContent = `GHS ${parseFloat(metricsData.myProfit).toFixed(2)}`; // Use myProfit from the backend
Â  Â  Â  Â  Â  Â  Â  Â  metrics.orders.textContent = metricsData.totalOrders.toLocaleString();
Â  Â  Â  Â  Â  Â  Â  Â  metrics.users.textContent = userData.count.toLocaleString();
Â  Â  Â  Â  Â  Â  Â  Â  return true;
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Metrics fetch error:', error);
Â  Â  Â  Â  Â  Â  Â  Â  metrics.revenue.textContent = 'Error';
Â  Â  Â  Â  Â  Â  Â  Â  metrics.profit.textContent = 'Error';
Â  Â  Â  Â  Â  Â  Â  Â  return false;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function fetchAllOrders() {
Â  Â  Â  Â  Â  Â  ordersStatusDiv.textContent = 'Loading transactions...';
Â  Â  Â  Â  Â  Â  ordersTableBody.innerHTML = '<tr><td colspan="7" class="py-4 text-center text-blue-500 font-medium">Loading...</td></tr>';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const secret = adminSecretInput.value.trim();
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(`/api/get-all-orders?secret=${secret}`);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (response.status === 403) throw new Error('Authorization Failed. Check Admin Secret.');
Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) throw new Error('Could not fetch all orders.');
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  allOrders = data.orders || [];
Â  Â  Â  Â  Â  Â  Â  Â  renderOrders(allOrders);

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  ordersStatusDiv.textContent = `Error fetching orders: ${error.message}`;
Â  Â  Â  Â  Â  Â  Â  Â  ordersStatusDiv.style.color = 'red';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  async function fetchAllUsers() {
Â  Â  Â  Â  Â  Â  clientsStatusDiv.textContent = 'Loading client data...';
Â  Â  Â  Â  Â  Â  // NOTE: Colspan updated to 7 for the loading row to cover the new column
Â  Â  Â  Â  Â  Â  clientsTableBody.innerHTML = '<tr><td colspan="7" class="py-4 text-center text-blue-500 font-medium">Loading...</td></tr>'; 
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const secret = adminSecretInput.value.trim();
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch(`/api/admin/all-users-status?secret=${secret}`);
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (response.status === 403) throw new Error('Authorization Failed. Check Admin Secret.');
Â  Â  Â  Â  Â  Â  Â  Â  if (!response.ok) throw new Error('Could not fetch all users.');
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  allUsers = data.users || [];
Â  Â  Â  Â  Â  Â  Â  Â  renderUsers(allUsers);
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  clientsStatusDiv.textContent = `Error fetching users: ${error.message}`;
Â  Â  Â  Â  Â  Â  Â  Â  clientsStatusDiv.style.color = 'red';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- RENDERING ---
Â  Â  Â  Â  
Â  Â  Â  Â  function renderUsers(users) {
Â  Â  Â  Â  Â  Â  clientsTableBody.innerHTML = '';
Â  Â  Â  Â  Â  Â  if (users.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  clientsStatusDiv.textContent = "No registered clients found.";
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  clientsStatusDiv.textContent = '';

Â  Â  Â  Â  Â  Â  users.forEach(user => {
Â  Â  Â  Â  Â  Â  Â  Â  const row = clientsTableBody.insertRow();
Â  Â  Â  Â  Â  Â  Â  Â  const statusText = user.isOnline ? 'Online' : 'Offline';
Â  Â  Â  Â  Â  Â  Â  Â  const statusClass = user.isOnline ? 'status-online' : 'status-offline';
Â  Â  Â  Â  Â  Â  Â  Â  const roleColor = user.role === 'Agent' ? 'text-primary' : (user.role === 'Admin' ? 'text-red-500' : 'text-gray-500 dark:text-gray-400');

Â  Â  Â  Â  Â  Â  Â  Â  row.className = 'hover:bg-gray-50 transition duration-150 dark:hover:bg-gray-800';

Â  Â  Â  Â  Â  Â  Â  Â  row.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="py-4 px-6 font-medium text-gray-800 dark:text-gray-300">${user.username}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="py-4 px-6 text-xs dark:text-gray-400">${user.email}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="py-4 px-6 font-semibold ${roleColor}">${user.role}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="py-4 px-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="px-3 py-1 text-white text-xs font-bold uppercase rounded-full ${statusClass}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${statusText}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="py-4 px-6 text-xs dark:text-gray-400">${safeDateFormatter(user.signedUp)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="py-4 px-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-id="${user._id}" data-username="${user.username}" data-role="${user.role || 'Client'}"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â class="open-role-modal-btn bg-blue-600 hover:bg-blue-700 text-white text-xs font-medium py-1 px-3 rounded transition">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Change Role
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td> Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="py-4 px-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <button data-id="${user._id}" data-username="${user.username}"
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â class="delete-user-btn bg-red-600 hover:bg-red-700 text-white text-xs font-medium py-1 px-3 rounded transition">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â Delete
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â </button>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  function renderOrders(orders) {
Â  Â  Â  Â  Â  Â  // Apply current status filter before rendering
Â  Â  Â  Â  Â  Â  const currentStatusFilter = statusFilter.value;
Â  Â  Â  Â  Â  Â  let filteredOrders = orders;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (currentStatusFilter !== 'All') {
Â  Â  Â  Â  Â  Â  Â  Â  filteredOrders = orders.filter(order => order.status === currentStatusFilter);
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  ordersTableBody.innerHTML = '';
Â  Â  Â  Â  Â  Â  if (filteredOrders.length === 0) {
Â  Â  Â  Â  Â  Â  Â  Â  ordersStatusDiv.textContent = "No transactions found matching the filter criteria.";
Â  Â  Â  Â  Â  Â  Â  Â  ordersStatusDiv.style.color = 'black';
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  ordersStatusDiv.textContent = `Displaying ${filteredOrders.length} transactions.`;
Â  Â  Â  Â  Â  Â  ordersStatusDiv.style.color = 'black';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  filteredOrders.forEach(order => {
Â  Â  Â  Â  Â  Â  Â  Â  const row = ordersTableBody.insertRow();
Â  Â  Â  Â  Â  Â  Â  Â  const statusText = statusMap[order.status] || order.status.replace(/_/g, ' ');
Â  Â  Â  Â  Â  Â  Â  Â  const statusClass = `status-${order.status}`;
Â  Â  Â  Â  Â  Â  Â  Â  const amountSign = (order.dataPlan === 'WALLET TOP-UP') ? '+' : (order.dataPlan === 'WITHDRAWAL REQUEST' ? 'PAYOUT: ' : 'COST: ');
Â  Â  Â  Â  Â  Â  Â  Â  const amountColor = (order.dataPlan === 'WALLET TOP-UP') ? 'text-green-600 dark:text-green-400' : 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â (order.dataPlan === 'WITHDRAWAL REQUEST' ? 'text-blue-600 dark:text-blue-400' : 'text-red-600 dark:text-red-400');
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // Determine what to display in the Phone column
Â  Â  Â  Â  Â  Â  Â  Â  let displayPhone;
Â  Â  Â  Â  Â  Â  Â  Â  if (order.dataPlan === 'WITHDRAWAL REQUEST') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayPhone = `${order.network || 'Account'}: ${order.phoneNumber || 'N/A'}`;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (order.network === 'WALLET') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayPhone = 'N/A (Wallet)';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  displayPhone = order.phoneNumber || 'N/A';
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  // ðŸ›‘ NEW: Check if this is an Agent Sale (requires backend to send agentId)
Â  Â  Â  Â  Â  Â  Â  Â  let networkDisplay = `${order.dataPlan} (${order.network})`;
Â  Â  Â  Â  Â  Â  Â  Â  if (order.agentId) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  networkDisplay += ` <span class="bg-purple-100 text-purple-800 text-xs font-bold px-2 py-0.5 rounded dark:bg-purple-900 dark:text-purple-300">[AGENT SALE]</span>`;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  row.className = 'hover:bg-gray-50 transition duration-150 dark:hover:bg-gray-800';
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // Determine button text based on status
Â  Â  Â  Â  Â  Â  Â  Â  let actionButton = 'N/A';
Â  Â  Â  Â  Â  Â  Â  Â  if (order.status === 'pending_review') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actionButton = `<button data-id="${order.id}" class="open-modal-btn text-white bg-blue-600 hover:bg-blue-700 text-xs font-medium py-1 px-3 rounded transition">Fulfill Data</button>`;
Â  Â  Â  Â  Â  Â  Â  Â  } else if (order.status === 'withdrawal_pending') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  actionButton = `<button data-id="${order.id}" class="open-modal-btn text-white bg-yellow-600 hover:bg-yellow-700 text-xs font-medium py-1 px-3 rounded transition">Fulfill Payout</button>`;
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  row.innerHTML = `
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="py-4 px-6 dark:text-gray-400 text-xs">${safeDateFormatter(order.created_at)}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="py-4 px-6 font-medium text-gray-800 dark:text-gray-300">${order.username || 'N/A'}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="py-4 px-6 dark:text-gray-400 text-xs">${displayPhone}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="py-4 px-6 dark:text-gray-400 text-xs">${networkDisplay}</td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="py-4 px-6 font-semibold ${amountColor}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${amountSign} GHS ${order.amount.toFixed(2)}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="py-4 px-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <span class="px-3 py-1 text-white text-xs font-bold uppercase rounded-full ${statusClass}">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${statusText}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  <td class="py-4 px-6">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  ${actionButton}
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  Â  Â  `;
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // --- MODAL & ACTION LOGIC ---
Â  Â  Â  Â  
Â  Â  Â  Â  let currentOrderId = null;

Â  Â  Â  Â  // Function to open the modal, accepts the clicked button element
Â  Â  Â  Â  function openUpdateModal(buttonElement) {
Â  Â  Â  Â  Â  Â  currentOrderId = buttonElement.dataset.id;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Find the order data to populate the modal fields
Â  Â  Â  Â  Â  Â  const order = allOrders.find(o => o.id === currentOrderId);
Â  Â  Â  Â  Â  Â  modalPayoutDetails.classList.add('hidden'); 

Â  Â  Â  Â  Â  Â  if (order) {
Â  Â  Â  Â  Â  Â  Â  Â  modalOrderRef.textContent = order.reference ? order.reference.substring(0, 16) + '...' : currentOrderId.substring(0, 8) + '...';
Â  Â  Â  Â  Â  Â  Â  Â  modalCurrentStatus.textContent = statusMap[order.status] || order.status.replace(/_/g, ' ');
Â  Â  Â  Â  Â  Â  Â  Â  modalStatusMessage.textContent = ''; 
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  // 1. Check if it's a Payout Request
Â  Â  Â  Â  Â  Â  Â  Â  if (order.status === 'withdrawal_pending') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Display Payout Details
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalPayoutAccount.textContent = `${order.network} (${order.phoneNumber}) - GHS ${order.amount.toFixed(2)}`;
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalPayoutDetails.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Pre-select the Payout Sent option
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalNewStatus.value = 'withdrawal_sent';
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  // Default to Data Sent for regular review
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalNewStatus.value = 'data_sent'; 
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  modalBackdrop.style.opacity = 1;
Â  Â  Â  Â  Â  Â  Â  Â  modalBackdrop.style.display = 'flex';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function closeModal() {
Â  Â  Â  Â  Â  Â  modalBackdrop.style.opacity = 0;
Â  Â  Â  Â  Â  Â  currentOrderId = null;
Â  Â  Â  Â  Â  Â  setTimeout(() => { modalBackdrop.style.display = 'none'; }, 300);
Â  Â  Â  Â  }

Â  Â  Â  Â  async function updateOrderStatus() {
Â  Â  Â  Â  Â  Â  if (!currentOrderId) return;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const newStatus = modalNewStatus.value;
Â  Â  Â  Â  Â  Â  const secret = adminSecretInput.value.trim();

Â  Â  Â  Â  Â  Â  modalUpdateBtn.disabled = true;
Â  Â  Â  Â  Â  Â  modalUpdateBtn.textContent = 'Saving...';
Â  Â  Â  Â  Â  Â  modalStatusMessage.textContent = 'Updating status...';
Â  Â  Â  Â  Â  Â  modalStatusMessage.classList.remove('text-red-500');
Â  Â  Â  Â  Â  Â  modalStatusMessage.classList.add('text-yellow-600');

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch('/api/admin/update-order', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  orderId: currentOrderId, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  newStatus: newStatus,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  adminSecret: secret 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  const data = await response.json();

Â  Â  Â  Â  Â  Â  Â  Â  if (response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast(data.message, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const index = allOrders.findIndex(o => o.id === currentOrderId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (index !== -1) { allOrders[index].status = newStatus; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  closeModal();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderOrders(allOrders); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 1000);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast(data.error || data.message || 'Update failed.', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalStatusMessage.textContent = data.error || data.message || 'Update failed.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalStatusMessage.classList.remove('text-yellow-600');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  modalStatusMessage.classList.add('text-red-500');
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  showToast('Network error during update.', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  modalStatusMessage.textContent = 'Network error during update.';
Â  Â  Â  Â  Â  Â  Â  Â  modalStatusMessage.classList.remove('text-yellow-600');
Â  Â  Â  Â  Â  Â  Â  Â  modalStatusMessage.classList.add('text-red-500');
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  modalUpdateBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  modalUpdateBtn.textContent = 'Update';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- DELETE CLIENT LOGIC ---
Â  Â  Â  Â  
Â  Â  Â  Â  // Function to open the delete modal
Â  Â  Â  Â  function openDeleteModal(userId, username) {
Â  Â  Â  Â  Â  Â  currentDeleteUserId = userId;
Â  Â  Â  Â  Â  Â  deleteUsernameDisplay.textContent = username;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  deleteBackdrop.style.opacity = 1;
Â  Â  Â  Â  Â  Â  deleteBackdrop.style.display = 'flex';
Â  Â  Â  Â  }

Â  Â  Â  Â  // Function to close the delete modal
Â  Â  Â  Â  function closeDeleteModal() {
Â  Â  Â  Â  Â  Â  deleteBackdrop.style.opacity = 0;
Â  Â  Â  Â  Â  Â  currentDeleteUserId = null;
Â  Â  Â  Â  Â  Â  setTimeout(() => { deleteBackdrop.style.display = 'none'; }, 300);
Â  Â  Â  Â  }

Â  Â  Â  Â  // Executes the API call to delete the user
Â  Â  Â  Â  async function deleteClient() {
Â  Â  Â  Â  Â  Â  const userId = currentDeleteUserId;
Â  Â  Â  Â  Â  Â  const secret = adminSecretInput.value.trim();
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  if (!secret) {
Â  Â  Â  Â  Â  Â  Â  Â  closeDeleteModal();
Â  Â  Â  Â  Â  Â  Â  Â  showToast('Admin secret required to delete user.', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  document.getElementById('delete-modal-confirm').disabled = true;
Â  Â  Â  Â  Â  Â  document.getElementById('delete-modal-confirm').textContent = 'Deleting...';

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch('/api/admin/delete-user', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'DELETE',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ userId, adminSecret: secret })
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  const data = await response.json();
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  if (response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast(data.message, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await Promise.all([fetchAllUsers(), fetchAllOrders(), fetchMetrics()]);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast(data.error || data.message || 'Deletion failed.', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  showToast('Network error during client deletion.', 'error');
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  closeDeleteModal();
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('delete-modal-confirm').disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('delete-modal-confirm').textContent = 'Delete Permanently';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // Listener for the Delete Button on the table row (Delegation)
Â  Â  Â  Â  function handleUserDeleteClick(e) {
Â  Â  Â  Â  Â  Â  const button = e.target.closest('.delete-user-btn');
Â  Â  Â  Â  Â  Â  if (button) {
Â  Â  Â  Â  Â  Â  Â  Â  const userId = button.dataset.id;
Â  Â  Â  Â  Â  Â  Â  Â  const username = button.dataset.username;
Â  Â  Â  Â  Â  Â  Â  Â  openDeleteModal(userId, username);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // ðŸ›‘ USER ROLE CHANGE LOGIC ðŸ›‘
Â  Â  Â  Â  function openRoleModal(buttonElement) {
Â  Â  Â  Â  Â  Â  currentRoleUserId = buttonElement.dataset.id;
Â  Â  Â  Â  Â  Â  const username = buttonElement.dataset.username;
Â  Â  Â  Â  Â  Â  const currentRole = buttonElement.dataset.role;

Â  Â  Â  Â  Â  Â  roleModalUsername.textContent = username;
Â  Â  Â  Â  Â  Â  roleModalCurrentRole.textContent = currentRole;
Â  Â  Â  Â  Â  Â  roleModalNewRole.value = currentRole; 
Â  Â  Â  Â  Â  Â  roleModalMessage.textContent = ''; 
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  roleModalBackdrop.style.opacity = 1;
Â  Â  Â  Â  Â  Â  roleModalBackdrop.style.display = 'flex';
Â  Â  Â  Â  }

Â  Â  Â  Â  function closeRoleModal() {
Â  Â  Â  Â  Â  Â  roleModalBackdrop.style.opacity = 0;
Â  Â  Â  Â  Â  Â  currentRoleUserId = null;
Â  Â  Â  Â  Â  Â  setTimeout(() => { roleModalBackdrop.style.display = 'none'; }, 300);
Â  Â  Â  Â  }

Â  Â  Â  Â  async function updateUserRole() {
Â  Â  Â  Â  Â  Â  if (!currentRoleUserId) return;
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  const newRole = roleModalNewRole.value;
Â  Â  Â  Â  Â  Â  const secret = adminSecretInput.value.trim();

Â  Â  Â  Â  Â  Â  roleModalUpdateBtn.disabled = true;
Â  Â  Â  Â  Â  Â  roleModalUpdateBtn.textContent = 'Updating...';
Â  Â  Â  Â  Â  Â  roleModalMessage.textContent = 'Sending request...';
Â  Â  Â  Â  Â  Â  roleModalMessage.classList.remove('text-red-500');
Â  Â  Â  Â  Â  Â  roleModalMessage.classList.add('text-yellow-600');

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch('/api/admin/update-user-role', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  userId: currentRoleUserId, 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  newRole: newRole,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  adminSecret: secret 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  })
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  const data = await response.json();

Â  Â  Â  Â  Â  Â  Â  Â  if (response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast(data.message, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const userIndex = allUsers.findIndex(u => u._id === currentRoleUserId);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (userIndex !== -1) { allUsers[userIndex].role = newRole; }
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  setTimeout(() => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  closeRoleModal();
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderUsers(allUsers); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, 1000);
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast(data.error || data.message || 'Role update failed.', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  roleModalMessage.textContent = data.error || data.message || 'Role update failed.';
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  roleModalMessage.classList.remove('text-yellow-600');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  roleModalMessage.classList.add('text-red-500');
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  showToast('Network error during role update.', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  roleModalMessage.textContent = 'Network error during role update.';
Â  Â  Â  Â  Â  Â  Â  Â  roleModalMessage.classList.remove('text-yellow-600');
Â  Â  Â  Â  Â  Â  Â  Â  roleModalMessage.classList.add('text-red-500');
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  roleModalUpdateBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  roleModalUpdateBtn.textContent = 'Update Role';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  function handleRoleChangeClick(e) {
Â  Â  Â  Â  Â  Â  const button = e.target.closest('.open-role-modal-btn');
Â  Â  Â  Â  Â  Â  if (button) {
Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault();
Â  Â  Â  Â  Â  Â  Â  Â  openRoleModal(button);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // ðŸ›‘ RESET METRICS LOGIC ðŸ›‘
Â  Â  Â  Â  async function resetMetrics() {
Â  Â  Â  Â  Â  Â  const secret = adminSecretInput.value.trim();
Â  Â  Â  Â  Â  Â  if (!secret) { 
Â  Â  Â  Â  Â  Â  Â  Â  showToast("Admin secret required to reset metrics.", 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return; 
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  if (!confirm("ARE YOU SURE YOU WANT TO RESET METRICS? This action cannot be undone and will permanently zero out Total Revenue/My Profit metrics.")) {
Â  Â  Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  resetMetricsBtn.disabled = true;
Â  Â  Â  Â  Â  Â  resetMetricsBtn.textContent = 'Resetting...';

Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const response = await fetch('/api/admin/reset-metrics', {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  method: 'POST',
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  headers: { 'Content-Type': 'application/json' },
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  body: JSON.stringify({ adminSecret: secret })
Â  Â  Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  Â  Â  const data = await response.json();

Â  Â  Â  Â  Â  Â  Â  Â  if (response.ok) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast(data.message, 'success');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  await fetchMetrics(); 
Â  Â  Â  Â  Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  showToast(data.error || data.message || 'Metrics reset failed.', 'error');
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  showToast('Network error during metrics reset.', 'error');
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  resetMetricsBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  resetMetricsBtn.textContent = 'ðŸ”„ Reset Metrics';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }

Â  Â  Â  Â  // --- MAIN FETCH TRIGGER ---
Â  Â  Â  Â  
Â  Â  Â  Â  async function fetchAllData() {
Â  Â  Â  Â  Â  Â  const secret = adminSecretInput.value.trim();
Â  Â  Â  Â  Â  Â  if (!secret) { 
Â  Â  Â  Â  Â  Â  Â  Â  showToast("Please enter the Admin Secret.", 'error');
Â  Â  Â  Â  Â  Â  Â  Â  return; 
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  adminSecret = secret;

Â  Â  Â  Â  Â  Â  fetchDataBtn.disabled = true;
Â  Â  Â  Â  Â  Â  fetchDataBtn.textContent = 'Loading...';
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  const metricsReady = await fetchMetrics();
Â  Â  Â  Â  Â  Â  Â  Â  if (!metricsReady) { 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  throw new Error("Failed to load core metrics. Check secret."); 
Â  Â  Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  Â  Â  showToast("Metrics and User count loaded successfully.", 'success');
Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  await Promise.all([fetchAllOrders(), fetchAllUsers()]);

Â  Â  Â  Â  Â  Â  } catch (error) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error('Master Fetch Error:', error);
Â  Â  Â  Â  Â  Â  Â  Â  showToast(`CRITICAL ERROR: ${error.message}`, 'error');
Â  Â  Â  Â  Â  Â  } finally {
Â  Â  Â  Â  Â  Â  Â  Â  fetchDataBtn.disabled = false;
Â  Â  Â  Â  Â  Â  Â  Â  fetchDataBtn.textContent = 'Fetch All Data';
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  }
Â  Â  Â  Â  
Â  Â  Â  Â  // --- INITIALIZATION ---
Â  Â  Â  Â  document.addEventListener('DOMContentLoaded', async () => {
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // 2. Get Admin Secret from URL 
Â  Â  Â  Â  Â  Â  const urlParams = new URLSearchParams(window.location.search);
Â  Â  Â  Â  Â  Â  const initialSecret = urlParams.get('secret');
Â  Â  Â  Â  Â  Â  if (initialSecret) {
Â  Â  Â  Â  Â  Â  Â  Â  adminSecretInput.value = initialSecret;
Â  Â  Â  Â  Â  Â  Â  Â  adminSecret = initialSecret;
Â  Â  Â  Â  Â  Â  Â  Â  fetchAllData();
Â  Â  Â  Â  Â  Â  }

Â  Â  Â  Â  Â  Â  // 3. Attach Listeners
Â  Â  Â  Â  Â  Â  fetchDataBtn.addEventListener('click', fetchAllData);
Â  Â  Â  Â  Â  Â  resetMetricsBtn.addEventListener('click', resetMetrics); // ðŸ›‘ NEW LISTENER ðŸ›‘
Â  Â  Â  Â  Â  Â  modalUpdateBtn.addEventListener('click', updateOrderStatus);
Â  Â  Â  Â  Â  Â  modalCancelBtn.addEventListener('click', closeModal);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // Delete Modal Listeners
Â  Â  Â  Â  Â  Â  document.getElementById('delete-modal-cancel').addEventListener('click', closeDeleteModal);
Â  Â  Â  Â  Â  Â  document.getElementById('delete-modal-confirm').addEventListener('click', deleteClient);
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // ðŸ›‘ Role Modal Listeners (NEW) ðŸ›‘
Â  Â  Â  Â  Â  Â  roleModalUpdateBtn.addEventListener('click', updateUserRole);
Â  Â  Â  Â  Â  Â  roleModalCancelBtn.addEventListener('click', closeRoleModal);

Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // ðŸ›‘ CRITICAL FIX: EVENT DELEGATION FOR ORDER ACTION BUTTONS ðŸ›‘
Â  Â  Â  Â  Â  Â  ordersTableBody.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  const targetButton = e.target.closest('.open-modal-btn');
Â  Â  Â  Â  Â  Â  Â  Â  if (targetButton) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  e.preventDefault(); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  openUpdateModal(targetButton); 
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  // ðŸ›‘ CRITICAL FIX: EVENT DELEGATION FOR CLIENT DELETE/ROLE BUTTONS ðŸ›‘
Â  Â  Â  Â  Â  Â  clientsTableBody.addEventListener('click', handleUserDeleteClick);
Â  Â  Â  Â  Â  Â  clientsTableBody.addEventListener('click', handleRoleChangeClick);


Â  Â  Â  Â  Â  Â  // 4. Status Filter Listener (Applies filter immediately when value changes)
Â  Â  Â  Â  Â  Â  statusFilter.addEventListener('change', () => {
Â  Â  Â  Â  Â  Â  Â  Â  renderOrders(allOrders); 
Â  Â  Â  Â  Â  Â  });

Â  Â  Â  Â  Â  Â  // 5. Tab Switching Logic
Â  Â  Â  Â  Â  Â  tabsContainer.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  Â  Â  Â  const target = e.target.closest('.admin-tab');
Â  Â  Â  Â  Â  Â  Â  Â  if (target) {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  document.querySelectorAll('.admin-tab').forEach(tab => tab.classList.remove('active'));
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  target.classList.add('active');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tabContentTransactions.classList.add('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tabContentClients.classList.add('hidden');

Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  if (target.dataset.tab === 'transactions') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tabContentTransactions.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderOrders(allOrders); 
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  } else if (target.dataset.tab === 'clients') {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  tabContentClients.classList.remove('hidden');
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  renderUsers(allUsers);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  });
Â  Â  </script>
</body>
</html>
