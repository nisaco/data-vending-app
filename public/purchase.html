<script>
    const networkTabs = document.getElementById('network-tabs');
    const networkInput = document.getElementById('network');
    const dataplanSelect = document.getElementById('dataplan');
    const paymentForm = document.getElementById('paymentForm');
    const statusDiv = document.getElementById('status');
    const payButton = document.getElementById('pay-button');
    const phoneInput = document.getElementById('phone'); 
    const walletBalanceDisplay = document.getElementById('wallet-balance-display');
    const paymentMethodsContainer = document.getElementById('payment-methods');

    let userWalletBalance = 0; 
    
    const PAYSTACK_PUBLIC_KEY = 'pk_test_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'; 
    
    // --- PAYSTACK FEE CALCULATION (Modified to use 0.205% rate) ---
    function calculateTotalCharge(planPriceInPesewas) {
        const TRANSACTION_FEE_RATE = 0.00205; // ⬅️ UPDATED: 0.205%
        const TRANSACTION_FEE_FLAT = 80; 
        const TRANSACTION_FEE_CAP = 2000; 

        let totalFee = (planPriceInPesewas * TRANSACTION_FEE_RATE) + TRANSACTION_FEE_FLAT;
        totalFee = totalFee > TRANSACTION_FEE_CAP ? TRANSACTION_FEE_CAP : totalFee;
        
        let netFeeToPass = Math.max(0, totalFee - TRANSACTION_FEE_FLAT); 
        const totalAmountCharged = planPriceInPesewas + Math.round(netFeeToPass);
        
        return totalAmountCharged;
    }
    
    // --- UI UPDATE AND DATA FETCH (omitted for brevity, unchanged) ---
    function updatePayButton(selectedOption) {
        const priceInPesewas = parseInt(selectedOption.dataset.amount) || 0;
        const selectedMethod = paymentMethodsContainer.querySelector('.pay-option.active').dataset.method;
        
        if (priceInPesewas === 0) {
            payButton.textContent = 'Pay Now';
            payButton.disabled = true;
            return;
        }
        
        const sellingPriceGHS = (priceInPesewas / 100).toFixed(2);
        
        if (selectedMethod === 'wallet') {
            if (priceInPesewas > userWalletBalance) {
                payButton.textContent = `Insufficient Funds (GHS ${sellingPriceGHS})`;
                payButton.disabled = true;
            } else {
                payButton.textContent = `Pay GHS ${sellingPriceGHS} with Wallet`;
                payButton.disabled = false;
            }
        } else {
            payButton.textContent = `Pay GHS ${sellingPriceGHS}`;
            payButton.disabled = false;
        }
    }

    const fetchPlansForNetwork = (network) => {
        dataplanSelect.innerHTML = '<option value="" data-amount="0" selected disabled>Loading plans...</option>';
        payButton.disabled = true;

        fetch(`/api/data-plans?network=${network}`)
            .then(response => response.json())
            .then(plans => {
                dataplanSelect.innerHTML = '<option value="" data-amount="0" selected disabled>Select a Plan...</option>';
                if (!plans.length) { dataplanSelect.innerHTML = '<option value="" data-amount="0">No plans available</option>'; return; }
                
                plans.forEach(p => {
                    const opt = document.createElement('option');
                    opt.value = p.id; 
                    opt.dataset.amount = p.price; 
                    opt.textContent = `${p.name} - GHS ${(p.price / 100).toFixed(2)}`;
                    dataplanSelect.appendChild(opt);
                });
                updatePayButton(dataplanSelect.options[dataplanSelect.selectedIndex]);
            })
            .catch(() => { 
                dataplanSelect.innerHTML = '<option value="" data-amount="0">Could not load plans</option>'; 
            });
    };

    async function fetchUserInfo() {
        try {
            const response = await fetch('/api/user-info');
            if (response.ok) {
                const data = await response.json();
                userWalletBalance = data.walletBalance;
                walletBalanceDisplay.textContent = `GHS ${(userWalletBalance / 100).toFixed(2)}`;
            } else {
                userWalletBalance = 0;
                walletBalanceDisplay.textContent = 'GHS 0.00';
            }
        } catch (error) {
            userWalletBalance = 0;
            walletBalanceDisplay.textContent = 'GHS Err';
        }
    }
    
    const handlePaystackTransaction = (transactionType) => { /* ... implementation ... */ };
    const handleWalletPurchase = async () => { /* ... implementation ... */ };

    // --- EVENT LISTENERS (omitted for brevity, unchanged) ---
    networkTabs.addEventListener('click', (e) => {
        let target = e.target.closest('.network-tab');
        if (target) {
            document.querySelectorAll('.network-tab').forEach(tab => {
                tab.classList.remove('active', 'border-primary');
                tab.classList.add('border-transparent');
            });
            
            target.classList.add('active', 'border-primary');
            target.classList.remove('border-transparent');

            const network = target.dataset.network;
            networkInput.value = network; 
            fetchPlansForNetwork(network); 
        }
    });
    
    paymentMethodsContainer.addEventListener('click', (e) => {
        let target = e.target.closest('.pay-option');
        if (target) {
            document.querySelectorAll('.pay-option').forEach(option => option.classList.remove('active'));
            target.classList.add('active');
            
            const selected = dataplanSelect.options[dataplanSelect.selectedIndex];
            if (selected) updatePayButton(selected);
        }
    });

    document.addEventListener('DOMContentLoaded', () => {
        fetchUserInfo(); 
        
        const defaultTab = document.querySelector('.network-tab[data-network="MTN"]');
        if (defaultTab) {
            defaultTab.classList.add('active', 'border-primary');
            defaultTab.classList.remove('border-transparent');
            networkInput.value = 'MTN';
            fetchPlansForNetwork('MTN');
        }
    });
    
    dataplanSelect.addEventListener('change', (e) => updatePayButton(e.target.options[e.target.selectedIndex]));

    paymentForm.addEventListener("submit", function(e) {
        e.preventDefault();
        
        const selected = dataplanSelect.options[dataplanSelect.selectedIndex];
        const priceInPesewas = parseInt(selected.dataset.amount);
        const selectedMethod = paymentMethodsContainer.querySelector('.pay-option.active').dataset.method;
        
        if (!phoneInput.checkValidity()) {
            statusDiv.textContent = "Please enter a valid 10-digit phone number starting with 0.";
            statusDiv.style.color = "red";
            phoneInput.focus();
            return;
        }

        if (!selected || priceInPesewas === 0 || isNaN(priceInPesewas)) {
            statusDiv.textContent = "Please select a valid data plan.";
            statusDiv.style.color = "red";
            return;
        }
        
        if (selectedMethod === 'paystack') {
            handlePaystackTransaction('purchase');
        } else if (selectedMethod === 'wallet') {
            handleWalletPurchase();
        }
    });
</script>
